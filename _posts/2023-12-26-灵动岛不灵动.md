---
layout: post
title: "“【待更新】灵动岛不灵动”"
date: 2023-12-26 18:06 +0800
categories: [编程]
tags: [灵动岛,iOS开发]
---

近期在唯品会APP上做了三个灵动岛（实时活动）与业务结合的尝试

第一次尝试将订单待支付提醒与灵动岛结合：当用户下单后，APP创建一个待支付灵动岛提醒用户回到APP支付，当订单被支付或者取消、过期再销毁灵动岛。一开始没有后端资源支持，因此待支付灵动岛最初是纯客户端实现，通过快速实验快速出结果。结果数据证明灵动岛与业务结合是很有价值的。

通过AB测试，开启待支付灵动岛提醒后，可运营UV数+0.1%，可运营UV的转化率+0.05%。意思是假如是有100000个待支付订单，待支付灵动岛带回的可运营用户数增量有100个，并且这100个用户的转化率还会比不存在灵动岛时高0.05%。

有了数据证明价值，灵动岛业务正式立项了。二期待支付灵动岛接入了Push推送，用来Cover用户APP退后台的场景（原先无法感知退后台订单过期，以及跨平台的操作），灵动岛整个更新和销毁都依赖推送实现，但很快便发现了单纯依赖推送的坑

- 灵动岛的UI创建和更新Token是分开的
  - 灵动岛的Token是推送更新的关键，每个灵动岛都有专属的Token，用来定点推送。但是这个Token的获取是异步的，意味着你创建了灵动岛UI之后，需要一段时间才能从苹果那获取到Token，这段时间平均在1.25S左右。这意味着你无法在创建灵动岛后立刻对其进行推送更新。如果向后端注册Token时间晚于需要Token的时间，会导致灵动岛更新失败。针对这个问题我们后面加了前端本地的兜底逻辑，其实也可以后端做推送延迟重试解决，但后端延迟重试又会面临快速创建订单更新顺序错乱的问题，因此本地兜底是最保险的。

